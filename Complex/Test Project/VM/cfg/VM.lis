    1          Прогр ВЕР{
    2          
    3          ТАКТ 50;
    4          КОНСТ ВКЛ 1;
    5          КОНСТ ВЫКЛ 0;
    6          КОНСТ ОжиданиеОтветаОтАлгоритма 10;
    7          КОНСТ ЗадержкаОбъекта 10;
    8          
    9          /*Коды сообщений от оператора */ 
   10          ПЕРЕЧИСЛЕНИЕ {
   11          	КОМ2АУ_В_РУЧНОЕ_УПРАВЛЕНИЕ,
   12          	КОМ2АУ_ОТКЛЮЧИТЬ_РУЧНОЕ_УПРАВЛЕНИЕ,
   13          	КОМ2АУ_ВКЛЮЧИТЬ_СУШИЛКУ,
   14          	КОМ2АУ_ВЫКЛЮЧИТЬ_СУШИЛКУ
   15          };
   16          
   17          /*Коды сообщений к оператору */ 
   18          ПЕРЕЧИСЛЕНИЕ 
   19          {
   20          	АУ2ГУИ_ЕСТЬ_СУШИЛКА_В_РУЧНОЕ_УПРАВЛЕНИЕ,
   21          	АУ2ГУИ_ЕСТЬ_ОТКЛЮЧИТЬ_РУЧНОЕ_УПРАВЛЕНИЕ,
   22          	АУ2ГУИ_СУШИЛКА_ВЫКЛЮЧЕНА,
   23          	АУ2ГУИ_СУШИЛКА_ВКЛЮЧЕНА
   24          };
   25          
   26           /*Набор команд для БВ*/
   27           ПЕРЕЧИСЛЕНИЕ 
   28          {
   29          	БУС2БВ_РУЧНОЕ_УПРАВЛЕНИЕ_ВКЛЮЧЕНИЕ,
   30          	БУС2БВ_РУЧНОЕ_УПРАВЛЕНИЕ_ВЫКЛЮЧЕНИЕ,
   31          	БУС2БВ_АВТОМАТИЧЕСКОЕ_УПРАВЛЕНИЕ_РУКИ_ПОМЕЩЕНЫ,
   32          	БУС2БВ_АВТОМАТИЧЕСКОЕ_УПРАВЛЕНИЕ_РУКИ_УБРАНЫ,
   33          	БУС2БВ_КОНЕЦ_ШТАНОГО_РЕЖИМА	
   34          };
   35          
   36          /*Набор команд для БУС от БВ*/
   37          ПЕРЕЧИСЛЕНИЕ
   38          {
   39          	БВ2БУС_СЛЕДУЮЩИЙ_СЦЕНАРИЙ,
   40          	БВ2БУС_ОШИБКА_ОСТАНОВ
   41          };
   42          
   43          /*Набор Команд для ГОО */
   44          ПЕРЕЧИСЛЕНИЕ
   45          {
   46          	БВ2ГОО_ВключениеРучногоУправленияУспешно,
   47          	БВ2ГОО_ВыключениеРучногоУправленияУспешно,
   48          	БВ2ГОО_ВключениеАвтоматическоеУспешно,
   49          	БВ2ГОО_ВыключениеАвтоматическоеУспешно,
   50          	БВ2ГОО_
   51          };
   52          
   53          ПЕРЕЧИСЛЕНИЕ
   54          {
   55          	БВ2ГОО_ВключениеРучногоУправленияНЕУспешно = БВ2ГОО_ + 1,
   56          	БВ2ГОО_ВыключениеРучногоУправленияНЕУспешно,
   57          	БВ2ГОО_СамопроизвольноеОтключениеРежимаРучногоУправления,
   58          	БВ2ГОО_СамопроизвольноеВключениеРежимаРучногоУправления,
   59          	БВ2ГОО_ОШИБКА_СамопроизвольноеВыключениеВавтоматРежиме,
   60          	БВ2ГОО_ОШИБКА_СамопроизвольноеВключениеВавтоматРежиме
   61          };
   62          
   63          ФУНКЦИЯ ЦЕЛ  SendMsgGUICode       (ЦЕЛ);
   64          
   65          
   66          /*CA Input msg queue*/
   67          
   68          ФУНКЦИЯ ЦЕЛ GetNextMsgFromCA(ПУСТО);
   69          ФУНКЦИЯ ЦЕЛ GetMsgCodeFromCA(ПУСТО);  /*чтение из памяти кода события */
   70          
   71          /*SCM  Input msg queue*/
   72          ФУНКЦИЯ ЦЕЛ GetNextMsgFromSCM(ПУСТО);
   73          ФУНКЦИЯ ЦЕЛ GetMsgCodeFromSCM(ПУСТО);  /*чтение из памяти кода события */
   74          
   75          /*SCM  Output msg queue*/
   76          ФУНКЦИЯ ЦЕЛ SendMsgCodeToSCM(ЦЕЛ);
   77          
   78          ВХОД  ЛОГ_ВЫХОДЫ_ОТ_АУ1  0 0 8; /* имя, базовый адрес, доп. адр. порта, 8бит */
   79          ВХОД  ЛОГ_ВЫХОДЫ_ОТ_АУ2  0 1 8; /* имя, базовый адрес, доп. адр. порта, 8бит */
   80          ВХОД  ЛОГ_ВЫХОДЫ_ОТ_ВОУ1  0 2 8; /* имя, базовый адрес, доп. адр. порта, 8бит */
   81          ВХОД  ЛОГ_ВЫХОДЫ_ОТ_ВОУ2  0 3 8; /* имя, базовый адрес, доп. адр. порта, 8бит */
   82          
   83          ПРОЦ Инициализация
   84          {
   85          	ЛОГ К_РУКИ_ПОД_СУШИЛКОЙ    = {ЛОГ_ВЫХОДЫ_ОТ_ВОУ1[1]} ДЛЯ ВСЕХ;
   86          
   87          /* ВЫХОДНЫЕ СИГНАЛЫ (т.к. привязаны к модулю выходов): */ 
   88          	ЛОГ У_ВКЛ_СУШИЛКУ = {ЛОГ_ВЫХОДЫ_ОТ_АУ1[1]} ДЛЯ ВСЕХ;
   89          
   90          	ЛОГ ФлагРучноеУправление ДЛЯ ВСЕХ;
   91          	ЛОГ ФлагРучноеУправлениеПоддверждено  ДЛЯ ВСЕХ;
   92          	ЛОГ ФлагРукиПодСушилкой  ДЛЯ ВСЕХ;
   93          
   94          /*########  СОСТОЯНИЯ ПРОЦЕССА  #########*/
   95           СОСТ Начало
   96           {  /* NB: 1-е f-сост. 1-го проц. - активно по включению питания */
   97          	ФлагРучноеУправление = ВЫКЛ;
   98          	ФлагРучноеУправлениеПоддверждено = ВЫКЛ;
   99          	ФлагРукиПодСушилкой = ВЫКЛ;
  100          	/* СТАРТ ПРОЦ ЧтениеСообщенийОтАУ; */
  101          	СТАРТ ПРОЦ ЧтениеСообщенийОтБУС;
  102          	СТАРТ ПРОЦ КонтрольОтключенияРучногоУправления;
  103          	СТОП;
  104           }
  105          
  106          } /* \ПРОЦ */
  107          
  108          ПРОЦ ЧтениеСообщенийОтБУС{  
  109          ИЗ ПРОЦ Инициализация ФлагРучноеУправление, ФлагРукиПодСушилкой; 
  110          /* */
  111          ЦЕЛ КодСообщенияОтБУС ЛОКАЛ;
  112           СОСТ Начало{
  113              /*  читаем код и параметр события из кольцевого буфера в структуру */
  114              ЕСЛИ (GetNextMsgFromSCM()) 
  115          	{
  116          		КодСообщенияОтБУС = GetMsgCodeFromSCM();
  117          		ЕСЛИ (КодСообщенияОтБУС == БУС2БВ_РУЧНОЕ_УПРАВЛЕНИЕ_ВКЛЮЧЕНИЕ)
  118          		{
  119          			/* ФлагРучноеУправление = ВКЛ; */
  120          			СТОП ПРОЦ КонтрольАвтоматическойРаботыСушилки;
  121          			СТОП ПРОЦ КонтрольОтключенияРучногоУправления;
  122          			СТАРТ ПРОЦ КонтрольВключенияРучногоУправления;
  123          		}
  124          		ИНАЧЕ ЕСЛИ (КодСообщенияОтБУС == БУС2БВ_РУЧНОЕ_УПРАВЛЕНИЕ_ВЫКЛЮЧЕНИЕ)
  125          		{
  126          			/*ФлагРучноеУправление = ВЫКЛ; */
  127          			СТАРТ ПРОЦ КонтрольОтключенияРучногоУправления;
  128          			СТОП ПРОЦ КонтрольВключенияРучногоУправления;
  129          		}
  130          		ИНАЧЕ ЕСЛИ (КодСообщенияОтБУС == БУС2БВ_АВТОМАТИЧЕСКОЕ_УПРАВЛЕНИЕ_РУКИ_ПОМЕЩЕНЫ ||
  131          					КодСообщенияОтБУС == БУС2БВ_АВТОМАТИЧЕСКОЕ_УПРАВЛЕНИЕ_РУКИ_УБРАНЫ)
  132          		{
  133          		 /*	ФлагРучноеУправление = ВЫКЛ; */
  134          			ФлагРукиПодСушилкой = ВКЛ;
  135          			СТАРТ ПРОЦ КонтрольАвтоматическойРаботыСушилки;
  136          		}
  137          	}
  138          	ЗАЦИКЛИТЬ;
  139          }
  140          }
  141          
  142          ПРОЦ КонтрольАвтоматическойРаботыСушилки
  143          {
  144          ИЗ ПРОЦ Инициализация К_РУКИ_ПОД_СУШИЛКОЙ, У_ВКЛ_СУШИЛКУ;
  145          
  146          	СОСТ Начало
  147          	{
  148          		ЕСЛИ (К_РУКИ_ПОД_СУШИЛКОЙ == ВКЛ) В СОСТ ОжиданиеВключения;
  149          		ИНАЧЕ В СОСТ ОжиданиеОтключения; 
  150          	}
  151          	СОСТ ОжиданиеВключения
  152          	{
  153          		ЕСЛИ (У_ВКЛ_СУШИЛКУ == ВКЛ)
  154          		{
  155          			В СОСТ СушилкаВключена;
  156          			SendMsgGUICode(БВ2ГОО_ВключениеАвтоматическоеУспешно);
  157          		}
  158          			
  159          		ТАЙМАУТ ОжиданиеОтветаОтАлгоритма В СОСТ ОшибкаВключения;
  160          	}
  161          	СОСТ ОжиданиеОтключения
  162          	{
  163          		ЕСЛИ (У_ВКЛ_СУШИЛКУ == ВЫКЛ) 
  164          		{
  165          			В СОСТ СушилкаВыключена;
  166          			SendMsgGUICode(БВ2ГОО_ВыключениеАвтоматическоеУспешно);
  167          		}
  168          		ТАЙМАУТ ОжиданиеОтветаОтАлгоритма В СОСТ ОшибкаВыключения;		
  169          	}
  170          	СОСТ СушилкаВключена 
  171          	{
  172          		ЕСЛИ (У_ВКЛ_СУШИЛКУ == ВЫКЛ  && К_РУКИ_ПОД_СУШИЛКОЙ == ВКЛ)
  173          		{
  174          			SendMsgGUICode(БВ2ГОО_ОШИБКА_СамопроизвольноеВыключениеВавтоматРежиме);
  175          			СТОП;
  176          		}
  177          		ИНАЧЕ ЕСЛИ (К_РУКИ_ПОД_СУШИЛКОЙ == ВЫКЛ) В СОСТ ОжиданиеПеремен;
  178          	}
  179          	СОСТ ОжиданиеПеремен
  180          	{
  181          		ЕСЛИ (К_РУКИ_ПОД_СУШИЛКОЙ == ВКЛ) В СОСТ СушилкаВключена;
  182          		ТАЙМАУТ ЗадержкаОбъекта В СОСТ Начало;
  183          	}	
  184          	СОСТ ОшибкаВключения
  185          	{
  186          			SendMsgGUICode(БВ2ГОО_ВключениеРучногоУправленияНЕУспешно);
  187          			СТОП;
  188          	}
  189          	СОСТ ОшибкаВыключения
  190          	{
  191          		СТОП;
  192          	}
  193          	СОСТ СушилкаВыключена 
  194          	{
  195          		ЕСЛИ (У_ВКЛ_СУШИЛКУ == ВКЛ  && К_РУКИ_ПОД_СУШИЛКОЙ == ВЫКЛ)
  196          		{
  197          			SendMsgGUICode(БВ2ГОО_ОШИБКА_СамопроизвольноеВыключениеВавтоматРежиме);
  198          			СТОП;
  199          		}
  200          		ИНАЧЕ ЕСЛИ (К_РУКИ_ПОД_СУШИЛКОЙ == ВЫКЛ) В СОСТ Начало;
  201          	}
  202          }
  203          
  204          ПРОЦ КонтрольОтключенияРучногоУправления
  205          {
  206          ИЗ ПРОЦ Инициализация ФлагРучноеУправлениеПоддверждено;
  207          	СОСТ Старт
  208          	{
  209          		ЕСЛИ (ФлагРучноеУправлениеПоддверждено == ВЫКЛ)
  210          		{
  211          			SendMsgGUICode(БВ2ГОО_ВыключениеРучногоУправленияУспешно);
  212          			В СОСТ Контроль;
  213          		}
  214          		ТАЙМАУТ ОжиданиеОтветаОтАлгоритма В СЛЕДУЮЩЕЕ;
  215          	}
  216          	СОСТ Беда
  217          	{
  218          		SendMsgGUICode(БВ2ГОО_ВыключениеРучногоУправленияНЕУспешно);
  219          		СТОП;
  220          	}
  221          	СОСТ Контроль
  222          	{
  223          		ЕСЛИ (ФлагРучноеУправлениеПоддверждено != ВЫКЛ)
  224          		{
  225          			SendMsgGUICode(БВ2ГОО_СамопроизвольноеВключениеРежимаРучногоУправления);
  226          			СТОП;
  227          		}
  228          	}
  229          }
  230          
  231          ПРОЦ КонтрольВключенияРучногоУправления
  232          {
  233          ИЗ ПРОЦ Инициализация ФлагРучноеУправлениеПоддверждено;
  234          
  235          	СОСТ Старт
  236          	{
  237          		ЕСЛИ (ФлагРучноеУправлениеПоддверждено == ВКЛ)
  238          		{
  239          			SendMsgGUICode(БВ2ГОО_ВключениеРучногоУправленияУспешно);
  240          			В СОСТ Контроль;
  241          		}
  242          		ТАЙМАУТ ОжиданиеОтветаОтАлгоритма В СЛЕДУЮЩЕЕ;
  243          	}	
  244          	СОСТ Беда
  245          	{
  246          		SendMsgGUICode(БВ2ГОО_ВключениеРучногоУправленияНЕУспешно);
  247          		СТОП;
  248          	}
  249          	СОСТ Контроль
  250          	{
  251          		ЕСЛИ (ФлагРучноеУправлениеПоддверждено != ВКЛ)
  252          		{
  253          			SendMsgGUICode(БВ2ГОО_СамопроизвольноеОтключениеРежимаРучногоУправления);
  254          			СТОП;
  255          		}
  256          	}
  257          }
  258          
  259          
  260          }  /* \Прогр */

%RCSL-I-SUMMARY, Completed with 0 error(s).
%RCSL-I-SUMMARY, Completed with 0 warning(s).

 %RCSL-I-SUMMARY, Completed with 0 error(s).